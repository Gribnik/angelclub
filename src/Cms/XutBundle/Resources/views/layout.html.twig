{% extends '::base.html.twig' %}
{% block stylesheets %}
    <link href="{{ asset('bundles/cmsxut/css/screen.css') }}" type="text/css" rel="stylesheet" />
    {% if is_granted('ROLE_ADMIN') %}
        <link href="{{ asset('bundles/cmsblog/css/froala_editor/froala_editor.min.css') }}" rel="stylesheet" type="text/css">
        <link href="{{ asset('bundles/cmsblog/css/froala_editor/font-awesome.min.css') }}" rel="stylesheet" type="text/css">
    {% endif %}
{% endblock %}
{% block admin_toolbar %}
    {% if is_granted('ROLE_ADMIN') %}
        {{ include("CmsXutBundle:Admin:toolbar.html.twig") }}
    {% endif %}
{% endblock %}
{% block javascripts %}
    {# TODO: isolate one bundle from another #}
    <script type="text/javascript" src="{{ asset('bundles/cmsxut/js/libs/jquery.js') }}"></script>
    {% if is_granted('ROLE_ADMIN') %}
        <script type="text/javascript" src="{{ asset('bundles/cmsxut/js/libs/underscore.js') }}"></script>
        <script type="text/javascript" src="{{ asset('bundles/cmsxut/js/libs/backbone.js') }}"></script>

        <script type="text/javascript" src="{{ asset('bundles/cmsxut/js/libs/jqueryui/js/jquery-ui-1.10.4.min.js') }}"></script>
        <script type="text/javascript" src="{{ asset('bundles/cmsxut/js/libs/fileupload/js/jquery.fileupload.js') }}"></script>
        <script type="text/javascript" src="{{ asset('bundles/cmsxut/js/libs/fileupload/js/jquery.iframe-transport.js') }}"></script>
        <script type="text/javascript" src="{{ asset('bundles/cmsgallery/js/upload.js') }}"></script>


        <script type="text/javascript" src="{{ asset('bundles/cmsxut/js/gistedit.js') }}"></script>
        <script type="text/javascript" src="{{ asset('bundles/cmsblog/js/froala_editor/froala_editor.min.js') }}"></script>
        <script type="text/javascript">
            var saveImagesBinded = false;
            function imageUploadCallback(data, savePath)
            {
                $('#uploaded-images-wrapper').append(data.result.imageForm);

                if (false === saveImagesBinded) {
                    $('#save-upload').click(function() {
                        saveUploadedImages(savePath, false)
                    });
                    $('#cancel-upload').click(function() {
                       cancelUploadAction(savePath);
                    })
                    $('body').delegate('.uploaded-image-remove', 'click', function() {
                        previewRemoveAction($(this))
                    });
                    saveImagesBinded = true;
                }
            }

            function saveUploadedImages(savePath, removeAll)
            {
                var uploadedItemsAdditionalData = _serializeUploadedImagesData(removeAll);
                if (uploadedItemsAdditionalData.length > 0) {
                    $.ajax({
                        url: savePath,
                        data: { imagesDetails: uploadedItemsAdditionalData },
                        type: "POST"
                    }).done(function() {
                        location.reload();
                    }).fail(function() {
                        alert('There was error during processing your request');
                    });
                } else {
                    alert('There are no items to save');
                }
                return false;
            }

            function previewRemoveAction(element)
            {
                var imageRow = element.parents('.uploaded-image-row');
                var removeMark = imageRow.find('input[name="is_removed"]');
                removeMark.val('1');
                // TODO: Make an checkbox instead of hide entire row
                imageRow.toggle('100');
            }

            function cancelUploadAction(savePath)
            {
                saveUploadedImages(savePath, true);
            }

            function _serializeUploadedImagesData(markAsRemoved)
            {
                var uploadedItems = $('.uploaded-image-row');
                var uploadedItemsAdditionalData = [];
                if (uploadedItems.length > 0) {
                    uploadedItems.each(function() {
                        if (true === markAsRemoved) {
                            $(this).find('input[name="is_removed"]').val('1')
                        }
                        uploadedItemsAdditionalData.push($(this).serialize());
                    });
                }

                return uploadedItemsAdditionalData;
            }

            $(function() {
                var blog_new_form = new gistEditForm({
                    el: $('#admin-new-blogpost'),
                    viewPort: $('#post-new-wrapper'),
                    template: '#blog-form-template',
                    formPath: '{{ path('blog_post_new') }}'
                });

                var image_new_form = new gistEditForm({
                    el: $('#admin-new-image'),
                    viewPort: $('#image-new-wrapper'),
                    template: '#image-form-template',
                    formPath: '{{ path('gallery_image_new') }}',
                    renderCallback: function() {
                       $('#gallery-images').fileupload(
                        {
                            dataType: 'json',
                            url:'{{ path('gallery_images_upload') }}',
                            done: function(e, data) {
                                imageUploadCallback(data, '{{ path('gallery_images_massedit') }}');
                            }
                        });
                    }
                });
            });
        </script>
    {% endif %}
{% endblock %}
